---
- hosts: all
  tasks:
    - name: Test tunl0 routes
      shell: "! /sbin/ip ro | grep '/26 via' | grep -v tunl0"
      when: (ipip|default(false)) and (kube_network_plugin == 'calico')

- hosts: kube-master

  vars:
    agent_report_interval: 15
    netcheck_namespace: default
    netchecker_port: 31081

  tasks:
    - name: Wait for netchecker server
      shell: "{{ bin_dir }}/kubectl get pods --namespace {{netcheck_namespace}} | grep ^netchecker-server"
      run_once: true
      register: ncs_pod
      until: ncs_pod.stdout.find('Running') != -1
      retries: 10
      delay: 5
      when: "{{ deploy_netchecker|bool }}"

    - name: Wait for netchecker agents
      shell: "{{ bin_dir }}/kubectl get pods --namespace {{netcheck_namespace}} | grep '^netchecker-agent-.*Running'"
      run_once: true
      register: nca_pod
      until: "{{ nca_pod.stdout_lines|length }} >= {{ groups['all']|length * 2 }}"
      retries: 10
      delay: 5
      when: "{{ deploy_netchecker|bool }}"

    - name: Get netchecker agents
      uri: url=http://localhost:{{netchecker_port}}/api/v1/agents/ return_content=yes
      run_once: true
      register: agents
      when: "{{ deploy_netchecker|bool }}"

    - name: Give some time to netchecker agents to report
      pause: seconds={{ agent_report_interval }}
      when: "{{ ((agents.content|from_json|length) < groups['all']|length * 2 ) and (deploy_netchecker|bool) }}"

    - name: Check netchecker status
      uri: url=http://localhost:{{netchecker_port}}/api/v1/connectivity_check status_code=200
      run_once: true
      retries: 3
      delay: "{{ agent_report_interval }}"
      when: "{{ deploy_netchecker|bool }}"
